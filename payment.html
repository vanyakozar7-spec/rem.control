<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Płatność — Remont Control</title>
  <meta name="description" content="Płatność online za wybrany pakiet Remont Control." />
  <link rel="stylesheet" href="styles.css" />

  <!-- FAVICON / APP ICONS -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
</head>

<body>

<header class="nav">
  <div class="container nav-inner">

    <!-- LOGO (CSS variant A, stacked like PNG) -->
    <a class="brand brand-stacked" href="./" aria-label="Remont Control">
      <span class="logo-top">Remont</span>
      <span class="logo-bottom">
        <span class="logo-control">Control</span>
        <span class="logo-check">✓</span>
      </span>
    </a>

    <nav class="menu">
      <a href="about.html">O serwisie</a>
      <a href="terms.html">Zasady</a>
      <a class="btn" href="check.html">Sprawdź swój remont</a>
    </nav>

  </div>
</header>

<main class="container pay-wrap">

  <section class="hero">
    <div class="card">
      <h1 class="h1">Płatność online</h1>
      <p class="lead">
        Sprawdź podsumowanie. Po opłaceniu zamówienia dostaniesz potwierdzenie i zaczynamy analizę.
      </p>
      <p class="notice" style="margin-top:12px;">
        Jeśli nie widzisz danych — wróć do formularza i wyślij go ponownie.
      </p>
    </div>
  </section>

  <section class="section">
    <div class="pay-grid">

      <!-- LEFT: SUMMARY -->
      <div class="card">
        <h2 class="h2">Podsumowanie</h2>

        <div class="kv">
          <div class="k">Pakiet</div>
          <div class="v" id="sumPlan">—</div>
        </div>
        <div class="kv">
          <div class="k">Cena</div>
          <div class="v" id="sumPrice">—</div>
        </div>
        <div class="kv">
          <div class="k">E-mail</div>
          <div class="v" id="sumEmail">—</div>
        </div>
        <div class="kv">
          <div class="k">Miasto</div>
          <div class="v" id="sumCity">—</div>
        </div>
        <div class="kv">
          <div class="k">Metraż</div>
          <div class="v" id="sumArea">—</div>
        </div>

        <div class="smallgap"></div>

        <p class="small muted">
          Po płatności otrzymasz e-mail z potwierdzeniem oraz dalszymi instrukcjami.
        </p>
        <p class="small muted">
          Uwaga: Remont Control nie wykonuje remontów i nie odpowiada za pracę wykonawcy.
        </p>
      </div>

      <!-- RIGHT: PAY -->
      <div class="card">
        <h2 class="h2">Opłać zamówienie</h2>

        <p class="small muted">
          Tryb MVP (bez serwera): płatność realizujesz przez link płatności / checkout, a po sukcesie wracasz na stronę.
        </p>

        <div class="notice" style="margin-top:12px;">
          <strong>Do podłączenia:</strong> wklej swój link płatności dla każdego pakietu w kodzie (sekcja <span class="mono">PAYMENT_LINKS</span>).
        </div>

        <div style="margin-top:16px;">
          <button class="btn" id="payBtn" type="button">Opłać teraz</button>
          <a class="btn secondary" href="check.html" style="margin-left:10px;">Wróć</a>
        </div>

        <p class="small muted" style="margin-top:10px;">
          Klikając „Opłać teraz” akceptujesz <a href="terms.html">zasady</a>.
        </p>

        <hr class="divider" />

        <!-- TEST (keep for now) -->
        <p class="small muted">
          Test: jeśli jeszcze nie masz płatności, możesz użyć przycisku poniżej do sprawdzenia wysyłki leadów (bez opłaty).
        </p>
        <button class="btn secondary" id="testSendBtn" type="button">Test: wyślij zgłoszenie bez płatności</button>

        <p class="small muted" style="margin-top:10px;">
          Ten przycisk jest tylko do testów — usuń go przed reklamą lub schowaj za parametrem <span class="mono">?test=1</span>.
        </p>
      </div>

    </div>
  </section>

</main>

<footer class="footer">
  <div class="container">
    <p class="small">
      Remont Control to serwis informacyjno-kontrolny. Nie jesteśmy stroną umowy i nie gwarantujemy kosztu ani rezultatu prac.
      Widełki są orientacyjne i zależą od wielu czynników (miasto, metraż, stan, standard).
    </p>
    <p class="small" style="margin-top:8px;">
      <a href="./">Strona główna</a> • <a href="about.html">O serwisie</a> • <a href="terms.html">Zasady</a>
    </p>
  </div>
</footer>

<script>
(function () {
  // =========================
  // CONFIG
  // =========================
  const PRICES = { BASIC: "149 zł", PLUS: "299 zł", PREMIUM: "499 zł" };

  // PAYMENT LINKS (fill later)
  const PAYMENT_LINKS = {
    BASIC: "",   // e.g. "https://buy.stripe.com/..."
    PLUS: "",
    PREMIUM: ""
  };

  // ✅ YOUR EMAIL (FormSubmit)
  const FORMSUBMIT_ENDPOINT = "https://formsubmit.co/ajax/remontcontrol.info@gmail.com";

  // ✅ Thanks page in your repo is: thank-you.html
  const THANKS_URL = "thank-you.html";

  // localStorage key
  const STORAGE_KEY = "remontcontrol_lead";

  // =========================
  // HELPERS
  // =========================
  function safeText(v){ return (v === undefined || v === null || v === "") ? "—" : String(v); }

  function getLead(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e){
      return null;
    }
  }

  function normalizePlan(lead){
    const pRaw = lead && (lead["Wybrany pakiet"] || lead["Pakiet (wybór)"]);
    const p = pRaw ? String(pRaw).toUpperCase() : "PLUS";
    return (p === "BASIC" || p === "PLUS" || p === "PREMIUM") ? p : "PLUS";
  }

  function fillSummary(lead){
    const plan = normalizePlan(lead);
    document.getElementById("sumPlan").textContent  = plan;
    document.getElementById("sumPrice").textContent = PRICES[plan] || "—";
    document.getElementById("sumEmail").textContent = safeText(lead && (lead["E-mail"] || lead["Email"]));
    document.getElementById("sumCity").textContent  = safeText(lead && (lead["Miasto / województwo"] || lead["Miasto"]));
    document.getElementById("sumArea").textContent  = safeText(lead && lead["Metraż (m²)"]);
  }

  async function sendLeadToEmail(lead){
    if (!lead) throw new Error("Brak danych zgłoszenia (wróć do formularza check.html i wyślij ponownie).");

    const replyTo = (lead["E-mail"] || lead["Email"] || "").trim();

    // FormSubmit AJAX payload
    const payload = {
      _subject: "Nowe zgłoszenie — Remont Control",
      _template: "table",
      _captcha: "false",
      _replyto: replyTo,
      ...lead
    };

    const res = await fetch(FORMSUBMIT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error("Błąd wysyłki: " + res.status + " " + txt);
    }
    return true;
  }

  function goThanks(){
    window.location.href = THANKS_URL;
  }

  function hasTestParam(){
    try{
      const p = new URLSearchParams(window.location.search);
      return p.get("test") === "1";
    } catch(e){
      return false;
    }
  }

  // =========================
  // INIT
  // =========================
  const lead = getLead();
  fillSummary(lead);

  const plan = normalizePlan(lead);

  const payBtn = document.getElementById("payBtn");
  const testSendBtn = document.getElementById("testSendBtn");

  // Hide test button unless ?test=1
  if (!hasTestParam() && testSendBtn) {
    testSendBtn.style.display = "none";
  }

  // =========================
  // BUTTONS
  // =========================
  payBtn.addEventListener("click", async function(){
    const link = (PAYMENT_LINKS[plan] || "").trim();

    if (link) {
      window.location.href = link;
      return;
    }

    // No payment link yet: treat as MVP send + thanks
    payBtn.disabled = true;
    payBtn.textContent = "Wysyłam…";

    try {
      await sendLeadToEmail(lead);
      goThanks();
    } catch(e){
      alert("Nie udało się wysłać zgłoszenia.\n\n" + e.message);
      payBtn.disabled = false;
      payBtn.textContent = "Opłać teraz";
    }
  });

  // Test mode: always send + thanks
  if (testSendBtn) {
    testSendBtn.addEventListener("click", async function(){
      testSendBtn.disabled = true;
      testSendBtn.textContent = "Wysyłam…";

      try {
        await sendLeadToEmail(lead);
        goThanks();
      } catch(e){
        alert("Błąd wysyłki: " + e.message);
        testSendBtn.disabled = false;
        testSendBtn.textContent = "Test: wyślij zgłoszenie bez płatności";
      }
    });
  }

})();
</script>

</body>
</html>
